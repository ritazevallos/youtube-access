<!DOCTYPE html>
<meta charset="utf-8">
<head>
<link rel="stylesheet" type="text/css" href="style.css">
<link rel="stylesheet" type="text/css" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
<script src="http://d3js.org/d3.v3.min.js"></script>
<script src="http://www.parsecdn.com/js/parse-1.3.5.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/1.0.2/Chart.js"></script>
<!-- <script src="//code.jquery.com/ui/1.11.4/jquery-ui.js"></script> -->

<script src="clean_cats.js"></script>
<script src="d3canvas.js"></script>
<script src="helper.js"></script>
<script src="backend_helper.js"></script> 
<script src="cat_counts.js"></script>
<script src="chart_canvas.js"></script>
<script src="cat_buttons.js"></script>


<script>

function initializeDateToYesterday(){
  // get yesterday
  var date = new Date();
  date.setHours(0,0,0,0);
  date.setDate(date.getDate()-1);
  
  inp_date = date.toISOString().substring(0, 10);

  $('input[name=date_field]').val(inp_date);
}

// Added from Rita
function displayData(cat_counts){
  var display_type = $('input[name=viewAsOptions]:checked').val();

  if (display_type == "d3graph"){
    var d3_json = convertCatCountsToD3(cat_counts);
    drawVisualization(d3_json, 700, 500);
  } else if (display_type == "table"){
    drawTable(cat_counts);
  } else if (display_type == "chartjs"){

    addButtons(cat_counts);

    // add click handler to the buttons
    $('.cat_button').click(function(){
      var cat_name = $(this).data('cat_name');
      drawChart(cat_counts, cat_name);
    });
    drawChart(cat_counts, "All");
  } else {
    alert('Error in getData: display_type not of valid form [d3graph, table]');
  }
}


function checkAndGetDataForInput(){
  var date = new Date();

  try{
    date = new Date($('input[name=date_field]').val());

  } catch(err) {
    alert('Error: invalid date');
  }
  
  today = new Date();
  today.setHours(0,0,0,0);
  if (date.getTime() >= today.getTime()){
    alert('Error: Pick a date before today.');
  } else {

    date.setHours(0,0,0,0);
    date.setDate(date.getDate()+1);

    var next_date = new Date();
    next_date.setTime(date.getTime());
    next_date.setDate(next_date.getDate()+1);
    Parse.Cloud.run('getData', {date: date, next_date: next_date}).then(function(results){
      var num_results = results.length;
      console.log("Successfully checked database for date range "+date+" - "+next_date+".")

      if (num_results == 0){
        console.log("0 items match the query. Will query API instead and store data.");  
        
        // get the data, draw visualization when done and store in database
        callAPIforDate(date,next_date).then(function(cat_counts){

          console.log(cat_counts);
          Parse.Cloud.run('putCatCountsInDatabase',{cat_counts: cat_counts,date: date}).then(function(results){
            console.log('Successfully put in database.');
            console.log(results);
          }, function(error){
            console.log('Error saving.'+error.message);
          });

          displayData(cat_counts);
          
        }, function(error){
          console.log('Error calling API: '+error.message);
        });

      } else {
        // got results from database.
        console.log(num_results+" items match the query.");

        var cat_counts = convertDBresultsToCatCounts(results);
        displayData(cat_counts);

      }
    }, function(error){
      alert('Error, check console');
      console.log(error.message);
    });   
  }
}

$(function(){

  Parse.initialize("5ObGqjM7hqEobYaUiiyb6pQsjvXEkyVoxXwIXtHQ", "4IHI6LXZRjf17xy2IvsRLrSh2nnDJM2hMT3WvBEY");
  initializeDateToYesterday();

  $('input[name=date_field]').change(function(){
    $('#container').fadeTo('slow', 0.20);
    checkAndGetDataForInput();
  })

  $('input[name=viewAsOptions]').change(function(){
    $('#container').fadeTo('slow', 0.20);
    checkAndGetDataForInput();
  })

  checkAndGetDataForInput();


})
  
</script>

</head>
<body>
<div class="container-fluid">
  <div class="row vertical-align"> 
  
      <div class="btn-group">

      <button type="button" class="btn btn-primary btn-lg" data-toggle="modal" data-target="#about">
        About
      </button>

      <button type="button" class="btn btn-primary btn-lg" data-toggle="modal" data-target="#howto_caption">
        How to Caption Your Videos
      </button>  

      <button type="button" class="btn btn-primary btn-lg" data-toggle="modal" data-target="#resources">
        Resources
      </button>

    </div>
  </div>      

    <div class="row" id="view_as">
      View as: 
      <label class="radio-inline">
        <input type="radio" name="viewAsOptions" id="chart" value="chartjs" checked alt="View as ChartJS Graph"> ChartJS Graph
      </label>
      <label class="radio-inline">
        <input type="radio" name="viewAsOptions" id="table" value="table" alt="View as Table"> Table
      </label>
<!--       <label class="radio-inline">
        <input type="radio" name="viewAsOptions" id="d3graph" value="d3graph" checked> Animated pie graph
      </label> -->

    </div>

  <div class="row vertical-align">
    <div class="col-md-9" style="text-align: center"> 
      
      <h2>On <input type="date" name="date_field" style="display:inline"></input>,</h2>
      
      <div class="row">
        <div id="container">
          <div id="text-container">
            <div id="explanation" style="visibility: hidden;">
              <span id="percentage"></span><br/>
              of <span id="genre_name"></span> videos on Youtube were accessible*
            </div>
          </div>
          <!-- the D3 svg gets appended here -->
        </div>
        <!-- <canvas id="myChart" width="400" height="400"></canvas> -->
      </div>  

    </div>


    <div class="col-md-3" id="buttons">
    </div>


    <!-- <div class="col-md-3"> -->

    <!-- Modal -->
    <div class="modal fade" id="resources" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            <h4 class="modal-title" id="myModalLabel">Resources</h4>
          </div>
          <div class="modal-body">
              <a href="https://amara.org/en/">Amara.org</a> allows users to create captions for videos they don't own and share the videos with others. 
              <br><br>
              <a href="http://dhcc.org/">dhcc: Deaf-Hearing Communication Centre</a> provides interpreters, sensitivity training, and ASL classes. 
              <br><br>
              <a href="http://www.examiner.com/article/closed-captioning-vs-subtitles-and-what-you-should-know">Subtitles vs. Closed Captioning</a>
              <br><br>
              <a href="https://support.google.com/youtube/answer/2734796?hl=en" title="This link will take you to the YouTube Subtitle/CC support page."> Official YouTube Subtitle/CC support </a>
               <br><br>

               <a href="https://support.google.com/youtube/answer/2734698?hl=en" title="This link will take you to YouTube's support page for uploading subtitles and CC."> Official YouTube Subtitle/CC upload support </a>
               <br><br>
               <a href="https://creatoracademy.withgoogle.com/page/lesson/captions" title="This link will take you to the YouTube Creator Academy page on reaching a global audience through Subtitles/CC."> Learn more about reaching a global audience through Subtitles/CC </a>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>
    <!--end button trigger modal-->


    <!-- Modal -->
    <div class="modal fade" id="about" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            <h4 class="modal-title" id="myModalLabel">About</h4>
          </div>
          <div class="modal-body">
            <p>This data visualization was created by Hannah Bown, Rita Zevallos, and Jonah Schwartz, with the advice of Neil McDevitt (Executive Director of the <a href="http://dhcc.org/">dhcc</a>), during the 2015 evoHaX hackathon.</p>
              <p>Data was collected with the help of the <a href="http://bl.ocks.org/mbostock/5944371">Youtube Data API</a>.</p>

              <p> We'd like to see YouTube improve the visibility of their closed caption/subtitle options. For example, if the uploader could enable automatic YouTube subtitle generation
              during the upload process, we believe there would be a dramatic increase in the number of videos with this option enabled. Even better, this option could be enabled as default and the uploader could opt out. As it is now, uploaders must edit previously uploaded videos in order to enable this option. Making the process of adding closed captions/subtitles to videos as visible and easy as possible will make YouTube as a whole more accessible and welcoming. </p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>
    <!--end button trigger modal-->



    <!-- Modal -->
    <div class="modal fade" id="howto_caption" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            <h4 class="modal-title" id="myModalLabel">How to Caption Your Videos</h4>
          </div>
          <div class="modal-body">
            (Note: this process is not available on mobile devices)
             <br><br>
              <b>Step 1:</b> Navigate to YouTube's Video Manager, which is found in the Creator Studio.
              <br>
              <img src="figures/10.png" alt="Screenshot of Video Manager location" width = "150" title="YouTube's Video Manager location" style="vertical-align:middle">
              <br><br>
              <b>Step 2:</b> The option to add Subtitles and CC is under the down arrow next to the Edit button of the video you wish to change.
              <br>
              <img src="figures/1.png" alt="Screenshot of Subtitles and CC menu location" width = "250" title="Subtitles and CC menu location" style="vertical-align:middle"> 
              <br><br>
              <b>Step 3:</b> If you haven't already, you will be prompted to set the most spoken language in the video. 
              <br>
              <img src="figures/2.png" alt="Select video's primary language" width = "250" title="Video language selection" style="vertical-align:middle">
              <br><br>
              <b>Step 4:</b> Subtitles can be added in whatever language you prefer, using one of three methods:
              <br>
                <i>Upload a file:</i> allows you to upload a text transcript or timed subtitles file which should contain both text and time codes for when each line of text should be displayed. Position and style information can also be included. 
                <br>
                <i>Transcribe and set timings:</i> using this method, you can type everything that is said in the video and let YouTube automatically line up the text with the content of the video. Once it is finished, you can adjust the timing and content of the subtitles. 
                <br>
                <i>Create new subtitles or CC:</i> finally, you can type out the subtitles line by line and set the timing by hand. 
                <br>
                <img src="figures/5.png" alt="Screenshot Subtitle/CC options" width = "250" title="Options for adding Subtitles/CC to YouTube videos" style="vertical-align:middle">
                <br><br>
                
              Congratulations, your video can now reach many more people! 
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>
    <!--end button trigger modal-->

    </div>
    <!--end of columns-->
  </div>
</div>

<img src="" id="alt_chart_image" alt="THIS IS ALT TEXT FOR THE GRAPH">
<br>
<b>*</b>Captioning makes video content accessable to the Deaf and Hard of Hearing, to search engine optimization, and also to be translated from English into other languages